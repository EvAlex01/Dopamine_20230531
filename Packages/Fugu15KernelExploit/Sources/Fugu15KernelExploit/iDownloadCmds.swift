//
//  iDownloadCmds.swift
//  Fugu15KernelExploit
//
//  Created by Linus Henze.
//  Copyright Â© 2022 Pinauten GmbH. All rights reserved.
//

import Foundation
import iDownload
import MachO
import CBindings

let iDownloadCmds = [
    "help": iDownload_help,
    "autorun": iDownload_autorun,
    "tcload": iDownload_tcload,
    "start_jailbreakd": iDownload_jbdStart,
] as [String: iDownloadCmd]

func iDownload_help(_ hndlr: iDownloadHandler, _ cmd: String, _ args: [String]) throws {
    try hndlr.sendline("tcload <path to TrustCache>: Load a TrustCache")
}

func iDownload_autorun(_ hndlr: iDownloadHandler, _ cmd: String, _ args: [String]) throws {
    try iDownload_tcload(hndlr, "tcload", ["/var/jb/basebin/basebin.tc"])
}

func iDownload_tcload(_ hndlr: iDownloadHandler, _ cmd: String, _ args: [String]) throws {
    if args.count != 1 {
        try hndlr.sendline("Usage: tcload <path to TrustCache>")
        return
    }
    
    guard let krw = hndlr.krw else {
        throw iDownloadError.custom("No KRW support!")
    }
    
    let tcPath = hndlr.resolve(path: args[0])
    _ = try tcload(tcPath: tcPath, krw: krw, slide: hndlr.slide)

    try hndlr.sendline("Successfully loaded TrustCache!")
}

func iDownload_jbdStart(_ hndlr: iDownloadHandler, _ cmd: String, _ args: [String]) throws {

    do {
        try startJailbreakd()
    } catch let e {
        try hndlr.sendline(String(format:"\(e)"))
    }
}